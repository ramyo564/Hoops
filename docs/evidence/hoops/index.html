<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoops Evidence</title>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github-dark.min.css">
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
    <style>
        :root {
            color-scheme: dark;
            --bg: #080e18;
            --panel: #0f1623;
            --line: #233248;
            --text: #d8e2f2;
            --muted: #95a7c4;
            --blue: #58a6ff;
            --gold: #d29922;
            --green: #2ea043;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: Inter, 'Segoe UI', sans-serif;
            background: radial-gradient(circle at 20% 10%, #132034, var(--bg) 60%);
            color: var(--text);
            line-height: 1.5;
        }

        .index-header {
            position: sticky;
            top: 0;
            z-index: 50;
            border-bottom: 1px solid var(--line);
            background: rgba(8, 14, 24, 0.94);
            backdrop-filter: blur(5px);
        }

        .index-inner {
            width: min(1240px, 92vw);
            margin: 0 auto;
            padding: 12px 0;
        }

        .index-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .index-title {
            margin: 0;
            font-size: 0.96rem;
            color: var(--blue);
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.03em;
        }

        .index-toggle {
            display: inline-flex;
            border: 1px solid var(--line);
            border-radius: 6px;
            background: rgba(88, 166, 255, 0.08);
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            padding: 6px 10px;
            cursor: pointer;
        }

        .index-nav {
            margin-top: 10px;
            display: none;
            max-height: min(56vh, 460px);
            overflow: auto;
            padding-right: 2px;
        }

        .index-nav.is-open {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .index-link {
            color: var(--text);
            text-decoration: none;
            border: 1px solid var(--line);
            border-radius: 8px;
            padding: 6px 9px;
            display: block;
            background: rgba(88, 166, 255, 0.05);
            font-size: 0.78rem;
        }

        .index-link:hover {
            border-color: var(--blue);
        }

        .wrap {
            width: min(1240px, 92vw);
            margin: 0 auto;
            padding: 16px 0 60px;
        }

        .panel {
            background: linear-gradient(180deg, rgba(15, 22, 35, 0.96), rgba(9, 14, 24, 0.96));
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 18px 20px;
            margin-bottom: 16px;
        }

        h1,
        h2,
        h3 {
            margin: 0;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.03em;
        }

        h2 {
            font-size: 1rem;
            color: var(--gold);
            margin-bottom: 10px;
        }

        h3 {
            font-size: 0.88rem;
            color: var(--blue);
            margin-top: 12px;
            margin-bottom: 8px;
        }

        p,
        li {
            margin: 0;
            color: var(--text);
            font-size: 0.92rem;
        }

        ul {
            margin: 0;
            padding-left: 18px;
            display: grid;
            gap: 6px;
        }

        a {
            color: #9bc5ff;
        }

        .muted {
            color: var(--muted);
        }

        .case-summary {
            margin-bottom: 8px;
        }

        .badge {
            display: inline-block;
            border: 1px solid var(--green);
            color: #9be9a8;
            border-radius: 999px;
            padding: 2px 8px;
            font-size: 0.75rem;
            margin-bottom: 8px;
        }

        .code-snippet {
            margin-top: 8px;
            border: 1px solid var(--line);
            border-radius: 10px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.24);
        }

        .code-snippet-label {
            display: block;
            padding: 7px 10px;
            border-bottom: 1px solid var(--line);
            color: var(--blue);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.78rem;
            background: rgba(88, 166, 255, 0.08);
        }

        .code-snippet pre {
            margin: 0;
            padding: 10px 12px;
            overflow-x: auto;
        }

        .code-snippet pre code {
            display: block;
            white-space: pre;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.77rem;
            line-height: 1.5;
            color: inherit;
        }

        .code-snippet pre code.hljs {
            background: transparent;
            padding: 0;
        }

        .ok {
            color: #9be9a8;
        }

        .partial {
            color: #f7c75a;
        }

        .evidence-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
            margin-bottom: 16px;
            align-items: stretch;
        }

        .evidence-grid>.panel {
            margin-bottom: 0;
            height: 100%;
        }

        section[id] {
            scroll-margin-top: 96px;
        }

        @media (max-width: 920px) {
            .evidence-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 760px) {
            .index-toggle {
                display: inline-flex;
            }

            .index-nav {
                display: none;
                margin-top: 8px;
                border: 1px solid var(--line);
                border-radius: 10px;
                padding: 8px;
                background: rgba(8, 14, 24, 0.98);
            }

            .index-nav.is-open {
                display: grid;
                grid-template-columns: 1fr;
                gap: 6px;
            }

            .index-link {
                font-size: 0.76rem;
            }
        }
    </style>
</head>

<body>
    <header class="index-header">
        <div class="index-inner">
            <div class="index-top">
                <h1 class="index-title">HOOPS EVIDENCE INDEX</h1>
                <button id="index-toggle" class="index-toggle" type="button" aria-label="Toggle index navigation"
                    aria-controls="index-nav" aria-expanded="true">CLOSE</button>
            </div>
            <nav id="index-nav" class="index-nav is-open" aria-label="Evidence index"></nav>
        </div>
    </header>

    <main class="wrap">
        <section class="panel">
            <h2>Overview</h2>
            <p class="muted">Hybrid mode: each architecture card links to internal evidence and keeps README anchors.</p>
            <p class="muted" style="margin-top:8px;">Use the header index to jump across cards. On mobile, use the INDEX toggle.</p>
        </section>

        <section id="evidence-grid" class="evidence-grid"></section>

        <section class="panel">
            <h2>Note</h2>
            <p class="muted">This page maps card-level claims to concrete source paths in Hoops.</p>
            <p class="muted" style="margin-top:8px;">Back to architecture dashboard: <a href="../../index.html">Hoops/docs/index.html</a></p>
        </section>
    </main>

    <script type="module">
        import { templateConfig } from '../../config.js';
        import { learnMoreLinks } from '../../learnmore-links.js';

        const repoBase = 'https://github.com/ramyo564/Hoops/blob/main/';

        const codePathMap = {
            'hoops-domain-map': [
                'src/main/java/com/zerobase/hoops/entity/UserEntity.java',
                'src/main/java/com/zerobase/hoops/entity/GameEntity.java',
                'src/main/java/com/zerobase/hoops/entity/ReportEntity.java'
            ],
            'hoops-game-flow': [
                'src/main/java/com/zerobase/hoops/gameCreator/controller/GameController.java',
                'src/main/java/com/zerobase/hoops/gameCreator/service/GameService.java',
                'src/main/java/com/zerobase/hoops/gameCreator/service/ParticipantGameService.java'
            ],
            'hoops-social-flow': [
                'src/main/java/com/zerobase/hoops/friends/service/FriendService.java',
                'src/main/java/com/zerobase/hoops/invite/service/InviteService.java',
                'src/main/java/com/zerobase/hoops/gameUsers/service/GameUserService.java'
            ],
            'hoops-governance-flow': [
                'src/main/java/com/zerobase/hoops/reports/service/ReportService.java',
                'src/main/java/com/zerobase/hoops/manager/service/ManagerService.java',
                'src/main/java/com/zerobase/hoops/manager/repository/BlackListUserRepository.java'
            ],
            'hoops-chat-realtime': [
                'src/main/java/com/zerobase/hoops/chat/controller/ChatController.java',
                'src/main/java/com/zerobase/hoops/chat/service/ChatService.java',
                'src/main/java/com/zerobase/hoops/config/WebSocketConnectionConfig.java'
            ],
            'hoops-notification-sse': [
                'src/main/java/com/zerobase/hoops/alarm/controller/NotificationController.java',
                'src/main/java/com/zerobase/hoops/alarm/service/NotificationService.java',
                'src/main/java/com/zerobase/hoops/alarm/repository/EmitterRepository.java'
            ],
            'hoops-auth-security': [
                'src/main/java/com/zerobase/hoops/config/WebSecurityConfig.java',
                'src/main/java/com/zerobase/hoops/security/JwtAuthenticationFilter.java',
                'src/main/java/com/zerobase/hoops/users/oauth2/service/OAuth2Service.java'
            ],
            'hoops-ws-security-fix': [
                'src/main/java/com/zerobase/hoops/config/WebSocketConnectionConfig.java',
                'src/main/java/com/zerobase/hoops/security/JwtTokenExtract.java',
                'src/main/java/com/zerobase/hoops/gameUsers/repository/GameUserRepository.java'
            ],
            'hoops-chat-history-fix': [
                'src/main/java/com/zerobase/hoops/chat/service/ChatService.java',
                'src/main/java/com/zerobase/hoops/chat/service/MessageSender.java',
                'src/main/java/com/zerobase/hoops/chat/service/WebSocketMessageSender.java'
            ],
            'hoops-dynamic-search-spec': [
                'src/main/java/com/zerobase/hoops/gameUsers/repository/GameCheckOutSpecifications.java',
                'src/main/java/com/zerobase/hoops/gameUsers/service/GameUserService.java',
                'src/main/java/com/zerobase/hoops/gameUsers/controller/GameUserController.java'
            ],
            'hoops-common-dto-api': [
                'src/main/java/com/zerobase/hoops/gameUsers/controller/GameUserController.java',
                'src/main/java/com/zerobase/hoops/gameUsers/dto/GameSearchResponse.java',
                'src/main/java/com/zerobase/hoops/commonResponse/CustomApiResponse.java'
            ],
            'hoops-manner-concurrency': [
                'src/main/java/com/zerobase/hoops/gameUsers/repository/MannerPointRepository.java',
                'src/main/java/com/zerobase/hoops/gameUsers/service/GameUserService.java',
                'src/main/java/com/zerobase/hoops/entity/MannerPointEntity.java'
            ],
            'hoops-jwt-component': [
                'src/main/java/com/zerobase/hoops/security/JwtTokenExtract.java',
                'src/main/java/com/zerobase/hoops/config/JwtParserConfig.java',
                'src/main/java/com/zerobase/hoops/security/TokenProvider.java'
            ],
            'hoops-test-coverage': [
                'src/test/java/com/zerobase/hoops/gameCreator/service/GameServiceTest.java',
                'src/test/java/com/zerobase/hoops/chat/service/ChatServiceTest.java',
                'src/test/java/com/zerobase/hoops/reports/service/ReportServiceTest.java'
            ],
            'hoops-docker-standardization': [
                'Dockerfile',
                'docker-compose.yml'
            ],
            'hoops-multi-stage-build': [
                'Dockerfile'
            ],
            'hoops-github-actions-cicd': [
                '.github/workflows/hoops-backend-build-and-push.yml',
                'Dockerfile'
            ],
            'hoops-self-hosted-deploy': [
                '.github/workflows/hoops-backend-build-and-push.yml',
                'docker-compose.yml'
            ],
            'hoops-aws-cost-optimization': [
                'docs/troubleShootings.md',
                'docker-compose.yml'
            ],
            'hoops-rds-private-network': [
                'src/main/resources/application.yml',
                'docker-compose.yml'
            ],
            'hoops-redis-container-shift': [
                'src/main/java/com/zerobase/hoops/config/RedisConfig.java',
                'src/main/java/com/zerobase/hoops/users/repository/redis/AuthRepository.java',
                'docker-compose.yml'
            ]
        };

        const snippetMap = {
            'hoops-domain-map': {
                label: 'Entity Boundary Map',
                language: 'java',
                code: [
                    '@Entity(name = "users")',
                    'public class UserEntity implements UserDetails {',
                    '  @ElementCollection(fetch = FetchType.EAGER)',
                    '  private List<String> roles;',
                    '}',
                    '',
                    '@Entity(name = "game")',
                    'public class GameEntity {',
                    '  @ManyToOne',
                    '  @JoinColumn(nullable = false)',
                    '  private UserEntity user;',
                    '}'
                ].join('\n')
            },
            'hoops-game-flow': {
                label: 'Create Game + Creator Participation',
                language: 'java',
                code: [
                    'private CreateGameDto.Response createGame(Request request, UserEntity user) {',
                    '  GameEntity game = new CreateGameDto.Request().toEntity(request, user);',
                    '  gameRepository.save(game);',
                    '',
                    '  ParticipantGameEntity participantGame =',
                    '      new ParticipantGameEntity().toGameCreatorEntity(game, user, clock);',
                    '  participantGameRepository.save(participantGame);',
                    '}'
                ].join('\n')
            },
            'hoops-social-flow': {
                label: 'Friend Apply and Notification',
                language: 'java',
                code: [
                    'private ApplyFriendDto.Response applyFriend(UserEntity user, UserEntity friendUser) {',
                    '  FriendEntity friendEntity = new ApplyFriendDto.Request().toEntity(user, friendUser);',
                    '  friendRepository.save(friendEntity);',
                    '',
                    '  notificationService.send(NotificationType.FRIEND,',
                    '      friendUser, user.getNickName() + "의 친구신청이 도착했습니다.");',
                    '}'
                ].join('\n')
            },
            'hoops-governance-flow': {
                label: 'Report to Blacklist Lifecycle',
                language: 'java',
                code: [
                    'public void reportUser(ReportDto request) {',
                    '  checkExist(request, user);',
                    '  notificationService.send(NotificationType.REPORT, findManger(), ...);',
                    '  reportRepository.save(request.toEntity(user, reportedUser));',
                    '}',
                    '',
                    'private void validateBlackList(Long userId, Long reportedId) {',
                    '  if (alreadyBlackUser.isEmpty()) {',
                    '    blackListUserRepository.save(BlackListUserEntity.builder()',
                    '        .blackUser(reportedUserEntity)',
                    '        .endDate(LocalDate.now().plusDays(10))',
                    '        .build());',
                    '  }',
                    '}'
                ].join('\n')
            },
            'hoops-chat-realtime': {
                label: 'Realtime Message Fan-out',
                language: 'java',
                code: [
                    'for (ChatRoomEntity chatRoomEntity : chatRoomEntityList) {',
                    '  String nickName = chatRoomEntity.getUserEntity().getNickName();',
                    '  messageRepository.save(message.toEntity(user, chatRoomEntity));',
                    '  messageSender.send("/topic/" + gameId + "/" + nickName, chatMessage);',
                    '}'
                ].join('\n')
            },
            'hoops-notification-sse': {
                label: 'SSE Delivery',
                language: 'java',
                code: [
                    '@Transactional',
                    'public void send(NotificationType type, UserEntity receiver, String content) {',
                    '  NotificationEntity notificationEntity = createNotification(type, receiver, content);',
                    '  notificationRepository.save(notificationEntity);',
                    '  emitterRepository.findAllStartWithByUserId(String.valueOf(receiver.getId()))',
                    '      .forEach((key, emitter) -> {',
                    '        emitterRepository.saveEventCache(key, notificationEntity);',
                    '        sendToClient(emitter, key, NotificationDto.entityToDto(notificationEntity));',
                    '      });',
                    '}'
                ].join('\n')
            },
            'hoops-auth-security': {
                label: 'Security Filter Chain',
                language: 'java',
                code: [
                    'httpSecurity',
                    '  .sessionManagement(sm -> sm.sessionCreationPolicy(SessionCreationPolicy.STATELESS))',
                    '  .authorizeHttpRequests(request -> request',
                    '      .requestMatchers("/api/admin/**").hasRole("ADMIN")',
                    '      .anyRequest().authenticated())',
                    '  .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class)',
                    '  .addFilterBefore(jwtExceptionFilter, JwtAuthenticationFilter.class);'
                ].join('\n')
            },
            'hoops-ws-security-fix': {
                label: 'ChannelInterceptor Validation',
                language: 'java',
                code: [
                    'if (StompCommand.CONNECT.equals(accessor.getCommand())) {',
                    '  String authToken = accessor.getFirstNativeHeader("Authorization");',
                    '  String gameId = accessor.getFirstNativeHeader("gameId");',
                    '  if (!isValidUser(authToken, gameId)) {',
                    '    throw new CustomException(ErrorCode.NOT_ACCEPT_USER_FOR_GAME);',
                    '  }',
                    '}',
                    '',
                    'return participantGameRepository.existsByGame_IdAndUser_IdAndStatus(',
                    '    gameIdNumber, user.getId(), ParticipantGameStatus.ACCEPT);'
                ].join('\n')
            },
            'hoops-chat-history-fix': {
                label: 'Targeted History Delivery',
                language: 'java',
                code: [
                    'ChatRoomEntity chatRoom = chatRoomRepository',
                    '    .findByGameEntity_IdAndUserEntity_Id(gameIdNumber, user.getId())',
                    '    .orElseThrow(() -> new CustomException(ErrorCode.NOT_EXIST_CHATROOM));',
                    '',
                    'List<MessageEntity> messages = messageRepository.findByChatRoomEntity(chatRoom);',
                    'messageSender.send("/topic/" + gameId + "/" + user.getNickName(), messageDto);'
                ].join('\n')
            },
            'hoops-dynamic-search-spec': {
                label: 'Specification Composition',
                language: 'java',
                code: [
                    'Specification<GameEntity> spec = Specification.where(GameCheckOutSpecifications.notDeleted());',
                    'spec = spec.and(GameCheckOutSpecifications.startDate(localDate));',
                    'if (cityName != null) spec = spec.and(GameCheckOutSpecifications.withCityName(cityName));',
                    'if (fieldStatus != null) spec = spec.and(GameCheckOutSpecifications.withFieldStatus(fieldStatus));',
                    'if (gender != null) spec = spec.and(GameCheckOutSpecifications.withGender(gender));',
                    'if (matchFormat != null) spec = spec.and(GameCheckOutSpecifications.withMatchFormat(matchFormat));'
                ].join('\n')
            },
            'hoops-common-dto-api': {
                label: 'Single Endpoint + Common Response',
                language: 'java',
                code: [
                    '@GetMapping("/search")',
                    'public ResponseEntity<Page<GameSearchResponse>> findFilteredGames(...) {',
                    '  return ResponseEntity.ok(gameUserService.findFilteredGames(...));',
                    '}',
                    '',
                    'public static CustomApiResponse of(String title, String detail) {',
                    '  return CustomApiResponse.builder().title(title).detail(detail).build();',
                    '}'
                ].join('\n')
            },
            'hoops-manner-concurrency': {
                label: 'Duplicate Evaluation Guard',
                language: 'java',
                code: [
                    'boolean checking = mannerPointRepository.existsByUser_IdAndReceiver_IdAndGame_Id(',
                    '    userId, request.getReceiverId(), gameId);',
                    'if (checking) {',
                    '  throw new CustomException(ErrorCode.EXIST_RATE);',
                    '}',
                    'receiverEntity.saveMannerPoint(request.getPoint());',
                    'mannerPointRepository.save(request.toEntity(userEntity, receiverEntity, gameEntity));'
                ].join('\n')
            },
            'hoops-jwt-component': {
                label: 'Reusable JWT Extractor',
                language: 'java',
                code: [
                    'public UserEntity getUserFromToken(String authorizationHeader) {',
                    '  if (authorizationHeader == null || !authorizationHeader.startsWith("Bearer ")) {',
                    '    throw new CustomException(ErrorCode.INVALID_TOKEN);',
                    '  }',
                    '  String token = authorizationHeader.substring(7);',
                    '  Jws<Claims> claimsJws = jwtParser.parseClaimsJws(token);',
                    '  return userRepository.findByLoginIdAndDeletedDateTimeNull(claimsJws.getBody().getSubject())',
                    '      .orElseThrow(() -> new CustomException(ErrorCode.USER_NOT_FOUND));',
                    '}'
                ].join('\n')
            },
            'hoops-test-coverage': {
                label: 'Service Test Example',
                language: 'java',
                code: [
                    '@DisplayName("메세지 보내기 성공")',
                    '@Test',
                    'void testSendMessage() {',
                    '  when(chatRoomRepository.findByGameEntity_Id(1L)).thenReturn(Collections.singletonList(testChatRoom));',
                    '  chatService.sendMessage(testChatMessage, testGameId, testToken);',
                    '  verify(messageRepository, times(1)).save(any(MessageEntity.class));',
                    '  verify(messageSender, times(1)).send(eq("/topic/1/TestUser1"), eq(testChatMessage));',
                    '}'
                ].join('\n')
            },
            'hoops-docker-standardization': {
                label: 'Docker Runtime Standard',
                language: 'dockerfile',
                code: [
                    'FROM gradle:8.7.0-jdk17 AS build',
                    'WORKDIR /app',
                    'COPY . /app',
                    'RUN ./gradlew clean build --no-daemon',
                    '',
                    'FROM openjdk:17-slim-buster',
                    'COPY --from=build /app/build/libs/*.jar /app/hoops.jar',
                    'CMD ["java", "-jar", "/app/hoops.jar"]'
                ].join('\n')
            },
            'hoops-multi-stage-build': {
                label: 'Build/Runtime Split',
                language: 'dockerfile',
                code: [
                    'FROM gradle:8.7.0-jdk17 AS build',
                    'RUN ./gradlew clean build --no-daemon',
                    '',
                    'FROM openjdk:17-slim-buster',
                    'COPY --from=build /app/build/libs/*.jar /app/hoops.jar',
                    'USER javauser'
                ].join('\n')
            },
            'hoops-github-actions-cicd': {
                label: 'Build and Push Pipeline',
                language: 'yaml',
                code: [
                    'jobs:',
                    '  build-and-push:',
                    '    runs-on: ubuntu-latest',
                    '    steps:',
                    '      - uses: docker/login-action@v2',
                    '      - uses: docker/build-push-action@v4',
                    '        with:',
                    '          push: true',
                    '          tags: |',
                    '            ${{ secrets.DOCKERHUB_USERNAME }}/hoops-backend:${{ github.sha }}',
                    '            ${{ secrets.DOCKERHUB_USERNAME }}/hoops-backend:latest'
                ].join('\n')
            },
            'hoops-self-hosted-deploy': {
                label: 'Self-hosted Deploy Job',
                language: 'yaml',
                code: [
                    'deploy:',
                    '  needs: build-and-push',
                    '  runs-on: [ self-hosted, label-go ]',
                    '  steps:',
                    '    - name: Docker run',
                    '      run: |',
                    '        docker-compose pull',
                    '        docker-compose up -d',
                    '    - name: Clean up old images',
                    '      run: docker image prune -af'
                ].join('\n')
            },
            'hoops-aws-cost-optimization': {
                label: 'Cost Optimization Evidence',
                language: 'markdown',
                code: [
                    '| 문제 | 해결 | 결과 |',
                    '| --- | --- | --- |',
                    '| ElastiCache + RDS Public IP 비용 부담 | RDS Private 통신 전환 + Redis를 EC2 컨테이너로 운영 | 월 인프라 비용 약 80% 절감 |'
                ].join('\n')
            },
            'hoops-rds-private-network': {
                label: 'DB/Network Config',
                language: 'yaml',
                code: [
                    'spring:',
                    '  datasource:',
                    '    driver-class-name: org.mariadb.jdbc.Driver',
                    '    url: jdbc:mariadb://${DB_URL:host.docker.internal}/${DB_NAME:hoops}?...',
                    '    username: ${DB_USERNAME:root}',
                    '    password: ${DB_PASSWORD:1234}'
                ].join('\n')
            },
            'hoops-redis-container-shift': {
                label: 'Redis in Container + Config',
                language: 'yaml',
                code: [
                    'services:',
                    '  hoops-redis:',
                    '    image: redis',
                    '  hoops-backend:',
                    '    depends_on:',
                    '      - hoops-redis',
                    '',
                    '# RedisConfig',
                    '@Bean',
                    'public RedisConnectionFactory redisMailConnectionFactory() {',
                    '  return new LettuceConnectionFactory(host, port);',
                    '}'
                ].join('\n')
            }
        };

        const badgeMap = {
            'hoops-domain-map': 'BACKEND',
            'hoops-game-flow': 'BACKEND',
            'hoops-social-flow': 'BACKEND',
            'hoops-governance-flow': 'BACKEND',
            'hoops-chat-realtime': 'BACKEND',
            'hoops-notification-sse': 'BACKEND',
            'hoops-auth-security': 'BACKEND',
            'hoops-ws-security-fix': 'BACKEND',
            'hoops-chat-history-fix': 'ENGINEERING_CASE',
            'hoops-dynamic-search-spec': 'ENGINEERING_CASE',
            'hoops-common-dto-api': 'ENGINEERING_CASE',
            'hoops-manner-concurrency': 'ENGINEERING_CASE',
            'hoops-jwt-component': 'ENGINEERING_CASE',
            'hoops-test-coverage': 'ENGINEERING_CASE',
            'hoops-docker-standardization': 'DEVOPS',
            'hoops-multi-stage-build': 'DEVOPS',
            'hoops-github-actions-cicd': 'DEVOPS',
            'hoops-self-hosted-deploy': 'DEVOPS',
            'hoops-aws-cost-optimization': 'DEVOPS',
            'hoops-rds-private-network': 'DEVOPS',
            'hoops-redis-container-shift': 'DEVOPS'
        };

        const assessmentMap = {
            'hoops-aws-cost-optimization': { status: 'partial', text: 'Operational outcome is documented and infra changes are traceable, while exact cost telemetry is maintained outside source tree.' },
            'hoops-manner-concurrency': { status: 'partial', text: 'Current implementation guarantees duplicate-evaluation prevention; lock-level details are documented in troubleshooting history.' }
        };

        const defaultAssessment = { status: 'ok', text: 'Aligned: README claim is cross-checked with implementation paths and architecture card intent.' };

        const toggle = document.getElementById('index-toggle');
        const nav = document.getElementById('index-nav');
        const evidenceGrid = document.getElementById('evidence-grid');

        const closeNav = () => {
            nav.classList.remove('is-open');
            toggle.setAttribute('aria-expanded', 'false');
            toggle.textContent = 'INDEX';
        };

        toggle.addEventListener('click', () => {
            const nextOpen = !nav.classList.contains('is-open');
            nav.classList.toggle('is-open', nextOpen);
            toggle.setAttribute('aria-expanded', String(nextOpen));
            toggle.textContent = nextOpen ? 'CLOSE' : 'INDEX';
        });

        nav.addEventListener('click', (event) => {
            const target = event.target;
            if (target instanceof HTMLElement && target.classList.contains('index-link')) {
                closeNav();
            }
        });

        document.addEventListener('click', (event) => {
            const target = event.target;
            if (!(target instanceof Node)) {
                return;
            }
            if (!nav.contains(target) && !toggle.contains(target)) {
                closeNav();
            }
        });

        const serviceSections = Array.isArray(templateConfig?.serviceSections) ? templateConfig.serviceSections : [];
        const seen = new Set();
        const cards = [];

        serviceSections.forEach((section) => {
            const groups = Array.isArray(section?.groups) && section.groups.length > 0
                ? section.groups
                : [{ cards: section?.cards ?? [] }];

            groups.forEach((group) => {
                const groupCards = Array.isArray(group?.cards) ? group.cards : [];
                groupCards.forEach((card) => {
                    const id = String(card?.mermaidId ?? '').trim();
                    if (!id || seen.has(id)) {
                        return;
                    }
                    seen.add(id);
                    cards.push({
                        id,
                        title: card?.title ?? id,
                        description: card?.description ?? '',
                        readme: learnMoreLinks[id] ?? '#'
                    });
                });
            });
        });

        const toFileName = (path) => {
            const cleanPath = String(path || '').split('#')[0].split('?')[0];
            const parts = cleanPath.split('/').filter(Boolean);
            return parts.length > 0 ? parts[parts.length - 1] : cleanPath || 'source';
        };

        cards.forEach((card, index) => {
            const navLink = document.createElement('a');
            navLink.className = 'index-link';
            navLink.href = `#${card.id}`;
            navLink.textContent = `${index + 1}. ${card.title}`;
            nav.appendChild(navLink);

            const panel = document.createElement('section');
            panel.id = card.id;
            panel.className = 'panel';

            const badge = document.createElement('span');
            badge.className = 'badge';
            badge.textContent = badgeMap[card.id] || 'EVIDENCE';

            const heading = document.createElement('h2');
            heading.textContent = card.title;

            const summary = document.createElement('p');
            summary.className = 'case-summary';
            summary.textContent = card.description || 'Card evidence summary';

            const readmeHeader = document.createElement('h3');
            readmeHeader.textContent = 'README Source';
            const readmeList = document.createElement('ul');
            const readmeItem = document.createElement('li');
            const readmeLink = document.createElement('a');
            readmeLink.href = card.readme;
            readmeLink.target = '_blank';
            readmeLink.rel = 'noopener noreferrer';
            readmeLink.textContent = card.readme;
            readmeItem.appendChild(readmeLink);
            readmeList.appendChild(readmeItem);

            const codeHeader = document.createElement('h3');
            codeHeader.textContent = 'Code Evidence';
            const codeList = document.createElement('ul');
            const codePaths = Array.isArray(codePathMap[card.id]) && codePathMap[card.id].length > 0
                ? codePathMap[card.id]
                : ['docs/diagrams.js', 'docs/config.js'];

            codePaths.forEach((path) => {
                const item = document.createElement('li');
                const link = document.createElement('a');
                link.href = `${repoBase}${path}`;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.textContent = toFileName(path);
                link.title = path;
                link.setAttribute('aria-label', `Open source file ${path}`);
                item.appendChild(link);
                codeList.appendChild(item);
            });

            const snippetHeader = document.createElement('h3');
            snippetHeader.textContent = 'Code Snippet';
            const snippet = snippetMap[card.id] || {
                label: 'Implementation Pointer',
                language: 'text',
                code: codePaths.map((path) => `refer: ${path}`).join('\n')
            };

            const snippetBlock = document.createElement('div');
            snippetBlock.className = 'code-snippet';

            const snippetLabel = document.createElement('span');
            snippetLabel.className = 'code-snippet-label';
            snippetLabel.textContent = snippet.label || 'Key Implementation';

            const pre = document.createElement('pre');
            const code = document.createElement('code');
            code.className = `language-${snippet.language || 'text'}`;
            code.textContent = snippet.code || '';
            pre.appendChild(code);
            snippetBlock.append(snippetLabel, pre);

            const assessmentHeader = document.createElement('h3');
            assessmentHeader.textContent = 'Assessment';
            const assessment = assessmentMap[card.id] || defaultAssessment;
            const assessmentText = document.createElement('p');
            assessmentText.className = assessment.status;
            assessmentText.textContent = assessment.text;

            panel.append(
                badge,
                heading,
                summary,
                readmeHeader,
                readmeList,
                codeHeader,
                codeList,
                snippetHeader,
                snippetBlock,
                assessmentHeader,
                assessmentText
            );

            evidenceGrid.appendChild(panel);
        });

        if (window.hljs) {
            document.querySelectorAll('pre code').forEach((el) => window.hljs.highlightElement(el));
        }
    </script>
</body>

</html>
